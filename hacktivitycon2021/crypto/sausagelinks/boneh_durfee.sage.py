

# This file was *autogenerated* from the file boneh_durfee.sage
from sage.all_cmdline import *   # import sage library

_sage_const_7 = Integer(7); _sage_const_1 = Integer(1); _sage_const_0 = Integer(0); _sage_const_0p167 = RealNumber('0.167'); _sage_const_5 = Integer(5); _sage_const_2 = Integer(2); _sage_const_3 = Integer(3); _sage_const_549935778300831378406948873536278349781214706503360745280597408861216877781142622004454148443526758471040653633080987617044763942008023466559253761306561736450658314626615456982873023501736081710037081947666247132668118860186965548713647775109193997705890766881191577188287773692953347103686449329398217311195051172403636510262250822460785125486925931569891688688353900466632582649417645956790937903144901696446727579207702041958066277574559994377445136251040659 = Integer(549935778300831378406948873536278349781214706503360745280597408861216877781142622004454148443526758471040653633080987617044763942008023466559253761306561736450658314626615456982873023501736081710037081947666247132668118860186965548713647775109193997705890766881191577188287773692953347103686449329398217311195051172403636510262250822460785125486925931569891688688353900466632582649417645956790937903144901696446727579207702041958066277574559994377445136251040659); _sage_const_32204951698260962458157592984992469529416584332675382497988021285424821386904232277036373403101864193040613563796784569698857185940927175841205145358641690922026788366581684507467056308764343250379771013177468030580725648480591696059317745554974780583562695962973324819593002957827750301174079447431501960032717699255546396631743680242345092881301693065171460311485778344053788138555054294470951574964376432654831106364396876336137419860163278539415409181597819 = Integer(32204951698260962458157592984992469529416584332675382497988021285424821386904232277036373403101864193040613563796784569698857185940927175841205145358641690922026788366581684507467056308764343250379771013177468030580725648480591696059317745554974780583562695962973324819593002957827750301174079447431501960032717699255546396631743680242345092881301693065171460311485778344053788138555054294470951574964376432654831106364396876336137419860163278539415409181597819)
from sage.all import *
# Original: https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/boneh_durfee.sage

dimension_min = _sage_const_7 

def remove_unhelpful(BB, monomials, bound, current):
  if current == -_sage_const_1  or BB.dimensions()[_sage_const_0 ] <= dimension_min:
    return BB
  for ii in range(current, -_sage_const_1 , -_sage_const_1 ):
    if BB[ii, ii] >= bound:
      affected_vectors = _sage_const_0 
      affected_vector_index = _sage_const_0 
      for jj in range(ii + _sage_const_1 , BB.dimensions()[_sage_const_0 ]):
        if BB[jj, ii] != _sage_const_0 :
          affected_vectors += _sage_const_1 
          affected_vector_index = jj
      if affected_vectors == _sage_const_0 :
        #print "* removing unhelpful vector", ii
        BB = BB.delete_columns([ii])
        BB = BB.delete_rows([ii])
        monomials.pop(ii)
        BB = remove_unhelpful(BB, monomials, bound, ii-_sage_const_1 )
        return BB
      elif affected_vectors == _sage_const_1 :
        affected_deeper = True
        for kk in range(affected_vector_index + _sage_const_1 , BB.dimensions()[_sage_const_0 ]):
          if BB[kk, affected_vector_index] != _sage_const_0 :
            affected_deeper = False
        if affected_deeper and abs(bound - BB[affected_vector_index, affected_vector_index]) < abs(bound - BB[ii, ii]):
          #print "* removing unhelpful vectors", ii, "and", affected_vector_index
          BB = BB.delete_columns([affected_vector_index, ii])
          BB = BB.delete_rows([affected_vector_index, ii])
          monomials.pop(affected_vector_index)
          monomials.pop(ii)
          BB = remove_unhelpful(BB, monomials, bound, ii-_sage_const_1 )
          return BB
  return BB

def boneh_durfee_small_roots(pol, modulus, mm, tt, XX, YY):
    PR = PolynomialRing(ZZ, names=('u', 'x', 'y',)); (u, x, y,) = PR._first_ngens(3)
    Q = PR.quotient(x*y + _sage_const_1  - u) # u = xy + 1
    polZ = Q(pol).lift()
    UU = XX*YY + _sage_const_1 
    gg = []
    for kk in range(mm + _sage_const_1 ):
      for ii in range(mm - kk + _sage_const_1 ):
        xshift = x**ii * modulus**(mm - kk) * polZ(u, x, y)**kk
        gg.append(xshift)
    gg.sort()
    monomials = []
    for polynomial in gg:
      for monomial in polynomial.monomials():
        if monomial not in monomials:
          monomials.append(monomial)
    monomials.sort()
    for jj in range(_sage_const_1 , tt + _sage_const_1 ):
      for kk in range(floor(mm/tt) * jj, mm + _sage_const_1 ):
        yshift = y**jj * polZ(u, x, y)**kk * modulus**(mm - kk)
        yshift = Q(yshift).lift()
        gg.append(yshift)
        monomials.append(u**kk * y**jj)
    nn = len(monomials)
    BB = Matrix(ZZ, nn)
    for ii in range(nn):
      BB[ii, _sage_const_0 ] = gg[ii](_sage_const_0 , _sage_const_0 , _sage_const_0 )
      for jj in range(_sage_const_1 , ii + _sage_const_1 ):
        if monomials[jj] in gg[ii].monomials():
          BB[ii, jj] = gg[ii].monomial_coefficient(monomials[jj]) * monomials[jj](UU,XX,YY)
    BB = remove_unhelpful(BB, monomials, modulus**mm, nn-_sage_const_1 )
    nn = BB.dimensions()[_sage_const_0 ]
    if nn == _sage_const_0 :
      print("failure")
      return _sage_const_0 ,_sage_const_0 
    BB = BB.LLL()
    PR = PolynomialRing(ZZ, names=('w', 'z',)); (w, z,) = PR._first_ngens(2)
    pol1 = pol2 = _sage_const_0 
    for jj in range(nn):
      pol1 += monomials[jj](w*z+_sage_const_1 ,w,z) * BB[_sage_const_0 , jj] / monomials[jj](UU,XX,YY)
      pol2 += monomials[jj](w*z+_sage_const_1 ,w,z) * BB[_sage_const_1 , jj] / monomials[jj](UU,XX,YY)
    PR = PolynomialRing(ZZ, names=('q',)); (q,) = PR._first_ngens(1)
    rr = pol1.resultant(pol2)
    if rr.is_zero() or rr.monomials() == [_sage_const_1 ]:
      print("the two first vectors are not independant")
      return _sage_const_0 , _sage_const_0 
    rr = rr(q, q)
    soly = rr.roots()
    if len(soly) == _sage_const_0 :
      print("Your prediction (delta) is too small")
      return _sage_const_0 , _sage_const_0 
    soly = soly[_sage_const_0 ][_sage_const_0 ]
    ss = pol1(q, soly)
    solx = ss.roots()[_sage_const_0 ][_sage_const_0 ]
    return solx, soly

def boneh_durfee(n, e):
  delta = RR(_sage_const_0p167 ) # d ~ n^0.167
  m = _sage_const_5 
  t = round((_sage_const_1 -_sage_const_2 *delta) * m)
  X = ZZ(_sage_const_2 *floor(n**delta))
  # we have n = p^2q. so `phi(n) = n + {-(pq+pr+qr) + p+q+r)} - 1`.
  # we reconsidered boneh-durfee's attack then we have `x(A+y) + 1 = 0 mod e` where `A = (n-1)`
  # and (x, y) = (k, -(pq+pr+qr)+p+q+r). 
  Y = ZZ(floor(n**(_sage_const_2 /_sage_const_3 )))
  P = PolynomialRing(ZZ, names=('x', 'y',)); (x, y,) = P._first_ngens(2)
  A = ZZ((n-_sage_const_1 )/_sage_const_2 )
  pol = _sage_const_1  + x * (A + y)
  solx, soly = boneh_durfee_small_roots(pol, e, m, t, X, Y)
  print(solx, soly)
  if solx > _sage_const_0 :
    return int(pol(solx, soly) / e)
  return _sage_const_0 

if __name__ == "__main__":
  N = _sage_const_549935778300831378406948873536278349781214706503360745280597408861216877781142622004454148443526758471040653633080987617044763942008023466559253761306561736450658314626615456982873023501736081710037081947666247132668118860186965548713647775109193997705890766881191577188287773692953347103686449329398217311195051172403636510262250822460785125486925931569891688688353900466632582649417645956790937903144901696446727579207702041958066277574559994377445136251040659 
  e = _sage_const_32204951698260962458157592984992469529416584332675382497988021285424821386904232277036373403101864193040613563796784569698857185940927175841205145358641690922026788366581684507467056308764343250379771013177468030580725648480591696059317745554974780583562695962973324819593002957827750301174079447431501960032717699255546396631743680242345092881301693065171460311485778344053788138555054294470951574964376432654831106364396876336137419860163278539415409181597819 
  print(boneh_durfee(N, e))

